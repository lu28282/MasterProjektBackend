package com.example.MasterProjekt.service;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.Set;

import com.example.MasterProjekt.dao.VulnerabilityRepository;
import com.example.MasterProjekt.model.Cpe;
import com.example.MasterProjekt.model.Vulnerability;

import org.apache.maven.artifact.versioning.DefaultArtifactVersion;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;


@Service
public class VulnerabilityService {

    private VulnerabilityRepository vulnerabilityRepository;

    @Autowired
    public VulnerabilityService(VulnerabilityRepository vulnerabilityRepository) {
        this.vulnerabilityRepository = vulnerabilityRepository;
    }

    public Iterable<Vulnerability> getAllVulnerabilities() {
        return vulnerabilityRepository.findAll();
    }

    public List<Vulnerability> getAllVulnerabilitiesBySoftwareAndVersion(String software, String version) {
        List<Vulnerability> result = new ArrayList<Vulnerability>();
        Iterable<Vulnerability> allVulnerabilities = vulnerabilityRepository.findAll();

        for (Vulnerability vulnerability : allVulnerabilities) {
            Optional<Vulnerability> vulnerabilityOpt = checkIfCpeSoftwareMatches(vulnerability, software, version);
            if (!vulnerabilityOpt.isEmpty()) {
                result.add(vulnerabilityOpt.get());
            }
        }
        return result;
    }

    private Optional<Vulnerability> checkIfCpeSoftwareMatches(Vulnerability vulnerability, String software,
            String version) {
        Set<Cpe> cpeSet = vulnerability.getCpeSet();
        for (Cpe cpe : cpeSet) {
            if (cpe.getSoftware().equalsIgnoreCase(software)) {
                if (cpeMatchesVersions(cpe, version)) {
                    return Optional.of(vulnerability);
                }
            }
        }
        return Optional.empty();
    }

    private boolean cpeMatchesVersions(Cpe cpe, String version) {
        boolean matchesVersions = false;
        DefaultArtifactVersion googleVersion = new DefaultArtifactVersion(version);
        // Version matching
        if (!(cpe.getVersion() == null)) {
            DefaultArtifactVersion cpeVersion = new DefaultArtifactVersion(cpe.getVersion());
            if (googleVersion.compareTo(cpeVersion) == 0) {
                matchesVersions = true;
            }
        } // StartIncluding + EndExcluding
        else if (!(cpe.getVersionStartIncluding() == null) && !(cpe.getVersionEndExcluding() == null) && !matchesVersions) {
            DefaultArtifactVersion cpeVersionStartIncluding = new DefaultArtifactVersion(
                    cpe.getVersionStartIncluding());
            DefaultArtifactVersion cpeVersionEndExcluding = new DefaultArtifactVersion(cpe.getVersionEndExcluding());
            if (googleVersion.compareTo(cpeVersionStartIncluding) == 0
                    || googleVersion.compareTo(cpeVersionStartIncluding) > 0) {
                if (googleVersion.compareTo(cpeVersionEndExcluding) < 0) {
                    matchesVersions = true;
                }
            }
        }   // StartIncluding + EndIncluding 
        else if (!(cpe.getVersionStartIncluding() == null) && !(cpe.getVersionEndIncluding() == null) && !matchesVersions) {
            DefaultArtifactVersion cpeVersionStartIncluding = new DefaultArtifactVersion(
                    cpe.getVersionStartIncluding());
            DefaultArtifactVersion cpeVersionEndIncluding = new DefaultArtifactVersion(cpe.getVersionEndIncluding());
            if (googleVersion.compareTo(cpeVersionStartIncluding) == 0
                    || googleVersion.compareTo(cpeVersionStartIncluding) > 0) {
                if (googleVersion.compareTo(cpeVersionEndIncluding) == 0
                        || googleVersion.compareTo(cpeVersionEndIncluding) < 0) {
                    matchesVersions = true;
                }
            }
        } // StartExcluding + EndIncluding 
        else if (!(cpe.getVersionStartExcluding() == null) && !(cpe.getVersionEndIncluding() == null) && !matchesVersions) {
            DefaultArtifactVersion cpeVersionStartExcluding = new DefaultArtifactVersion(
                    cpe.getVersionStartExcluding());
            DefaultArtifactVersion cpeVersionEndIncluding = new DefaultArtifactVersion(cpe.getVersionEndIncluding());
            if (googleVersion.compareTo(cpeVersionStartExcluding) > 0) {
                if (googleVersion.compareTo(cpeVersionEndIncluding) == 0
                        || googleVersion.compareTo(cpeVersionEndIncluding) < 0) {
                    matchesVersions = true;
                }
            }
        }   // StartExcluding + EndExcluding 
        else if (!(cpe.getVersionStartExcluding() == null) && !(cpe.getVersionEndExcluding() == null) && !matchesVersions) {
            DefaultArtifactVersion cpeVersionStartExcluding = new DefaultArtifactVersion(
                    cpe.getVersionStartExcluding());
            DefaultArtifactVersion cpeVersionEndExcluding = new DefaultArtifactVersion(cpe.getVersionEndExcluding());
            if (googleVersion.compareTo(cpeVersionStartExcluding) > 0) {
                if (googleVersion.compareTo(cpeVersionEndExcluding) < 0) {
                    matchesVersions = true;
                }
            }
        } // StartIncluding
        else if (!(cpe.getVersionStartIncluding() == null) && !matchesVersions) {
            System.out.println("=========================");
            System.out.println("We should be here!");
            System.out.println("=========================");
            DefaultArtifactVersion cpeVersionStartIncluding = new DefaultArtifactVersion(cpe.getVersionStartIncluding());
            if(googleVersion.compareTo(cpeVersionStartIncluding) == 0 || googleVersion.compareTo(cpeVersionStartIncluding) > 0) {
                matchesVersions = true;
            }
        }  // StartExcluding
        else if (!(cpe.getVersionStartExcluding() == null) && !matchesVersions) {
            DefaultArtifactVersion cpeVersionStartExcluding = new DefaultArtifactVersion(cpe.getVersionStartExcluding());
            if(googleVersion.compareTo(cpeVersionStartExcluding) > 0) {
                matchesVersions = true;
            }
        } // EndIncluding
        else if (!(cpe.getVersionEndIncluding() == null) && !matchesVersions) {
            DefaultArtifactVersion cpeVersionEndIncluding = new DefaultArtifactVersion(cpe.getVersionEndIncluding());
            if(googleVersion.compareTo(cpeVersionEndIncluding) == 0 || googleVersion.compareTo(cpeVersionEndIncluding) < 0) {
                matchesVersions = true;
            }
        } // EndExcluding
        else if (!(cpe.getVersionEndExcluding() == null) && !matchesVersions) {
            DefaultArtifactVersion cpeVersionEndExcluding = new DefaultArtifactVersion(cpe.getVersionEndExcluding());
            if(googleVersion.compareTo(cpeVersionEndExcluding) < 0) {
                matchesVersions = true;
            }
        }

        return matchesVersions;
    }
}

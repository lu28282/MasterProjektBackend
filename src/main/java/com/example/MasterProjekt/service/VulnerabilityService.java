package com.example.MasterProjekt.service;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ExecutionException;

import com.example.MasterProjekt.model.Cpe;
import com.example.MasterProjekt.model.Vulnerability;
import com.example.MasterProjekt.pojo.SoftwareAndVersion;
import com.example.MasterProjekt.pojo.Technologie;
import com.example.MasterProjekt.repository.VulnerabilityRepository;

import org.apache.maven.artifact.versioning.DefaultArtifactVersion;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class VulnerabilityService {

    private VulnerabilityRepository vulnerabilityRepository;

    @Autowired
    public VulnerabilityService(VulnerabilityRepository vulnerabilityRepository) {
        this.vulnerabilityRepository = vulnerabilityRepository;
    }

    public List<Vulnerability> getAllVulnerabilities() {
        return vulnerabilityRepository.findAll();
    }

    public List<Vulnerability> getAllVulnerabilitiesForSoftwareSet(Set<String> allSoftwares) {
        return vulnerabilityRepository.findVulBySoftwares(allSoftwares);
    }

    public SoftwareAndVersion setVulnerabilityForSoftwareAndVersionIfPresent(SoftwareAndVersion software,
            List<Vulnerability> allVulnerabilitiesForEverySoftware) {
        List<Vulnerability> vulnerabilitiesForSoftware = new ArrayList<Vulnerability>();

        for (Vulnerability vul : allVulnerabilitiesForEverySoftware) {
            Vulnerability possibleVul = checkIfCpeSoftwareMatches(vul, software);
            if (possibleVul != null) {
                vulnerabilitiesForSoftware.add(possibleVul);
            }
        }

        software.setVulnerabilities(vulnerabilitiesForSoftware);
        return software;
    }

    public List<Technologie> setVulnerabilityForTechnologieIfPresent(List<Technologie> technologies,
            List<Vulnerability> allVulnerabilitiesForEverySoftware) {
        List<Technologie> allTechsContainingVulnerability = new ArrayList<Technologie>();

        for (Technologie tech : technologies) {
            Technologie technologie = excecutesetVulnerabilityForTechnologieIfPresent(tech,
                    allVulnerabilitiesForEverySoftware);
            if (technologie != null) {
                allTechsContainingVulnerability.add(technologie);
            }
        }

        return allTechsContainingVulnerability;
    }

    private Technologie excecutesetVulnerabilityForTechnologieIfPresent(Technologie tech,
            List<Vulnerability> allVulnerabilitiesForEverySoftware) {
        // List<Vulnerability> vulnerabilities = new ArrayList<Vulnerability>();
        // int size = allVulnerabilitiesForEverySoftware.size();
        // String software = tech.getApp().toLowerCase();
        // String version = tech.getVersion();
        // for (int i = 0; i < size; i++) {
        // Vulnerability vul =
        // checkIfCpeSoftwareMatches(allVulnerabilitiesForEverySoftware.get(i),
        // software, version);
        // if (vul != null) {
        // vulnerabilities.add(vul);
        // }
        // }

        // if (vulnerabilities.size() > 0) {
        // tech.setVulnerabilities(vulnerabilities);
        // return tech;
        // }

        return null;
    }

    private Vulnerability checkIfCpeSoftwareMatches(Vulnerability vulnerability,
            SoftwareAndVersion softwareAndVersion) {
        String software = softwareAndVersion.getSoftware();
        String version = softwareAndVersion.getVersion();

        Set<Cpe> cpeSet = vulnerability.getCpeSet();
        Iterator<Cpe> cpeItr = cpeSet.iterator();

        while (cpeItr.hasNext()) {
            Cpe cpe = cpeItr.next();
            if (cpe.getSoftware().equalsIgnoreCase(software) && cpeMatchesVersions(cpe, version)) {
                return vulnerability;
            }
        }

        return null;
    }

    private boolean cpeMatchesVersions(Cpe cpe, String version) {
        boolean matchesVersions = false;
        String versionStartIncluding = cpe.getVersionStartIncluding();
        String versionStartExcluding = cpe.getVersionStartExcluding();
        String versionEndIncluding = cpe.getVersionEndIncluding();
        String versionEndExcluding = cpe.getVersionEndExcluding();
        DefaultArtifactVersion googleVersion = new DefaultArtifactVersion(version);
        // Version matching
        if (!(cpe.getVersion() == null)) {
            DefaultArtifactVersion cpeVersion = new DefaultArtifactVersion(cpe.getVersion());
            if (googleVersion.compareTo(cpeVersion) == 0) {
                matchesVersions = true;
            }
        } // StartIncluding + EndExcluding
        else if (!(versionStartIncluding == null) && !(versionEndExcluding == null) && !matchesVersions) {
            DefaultArtifactVersion cpeVersionStartIncluding = new DefaultArtifactVersion(versionStartIncluding);
            DefaultArtifactVersion cpeVersionEndExcluding = new DefaultArtifactVersion(versionEndExcluding);
            if (googleVersion.compareTo(cpeVersionStartIncluding) == 0
                    || googleVersion.compareTo(cpeVersionStartIncluding) > 0) {
                if (googleVersion.compareTo(cpeVersionEndExcluding) < 0) {
                    matchesVersions = true;
                }
            }
        } // StartIncluding + EndIncluding
        else if (!(versionStartIncluding == null) && !(versionEndIncluding == null) && !matchesVersions) {
            DefaultArtifactVersion cpeVersionStartIncluding = new DefaultArtifactVersion(versionStartIncluding);
            DefaultArtifactVersion cpeVersionEndIncluding = new DefaultArtifactVersion(versionEndIncluding);
            if (googleVersion.compareTo(cpeVersionStartIncluding) == 0
                    || googleVersion.compareTo(cpeVersionStartIncluding) > 0) {
                if (googleVersion.compareTo(cpeVersionEndIncluding) == 0
                        || googleVersion.compareTo(cpeVersionEndIncluding) < 0) {
                    matchesVersions = true;
                }
            }
        } // StartExcluding + EndIncluding
        else if (!(versionStartExcluding == null) && !(versionEndIncluding == null) && !matchesVersions) {
            DefaultArtifactVersion cpeVersionStartExcluding = new DefaultArtifactVersion(versionStartExcluding);
            DefaultArtifactVersion cpeVersionEndIncluding = new DefaultArtifactVersion(versionEndIncluding);
            if (googleVersion.compareTo(cpeVersionStartExcluding) > 0) {
                if (googleVersion.compareTo(cpeVersionEndIncluding) == 0
                        || googleVersion.compareTo(cpeVersionEndIncluding) < 0) {
                    matchesVersions = true;
                }
            }
        } // StartExcluding + EndExcluding
        else if (!(versionStartExcluding == null) && !(versionEndExcluding == null) && !matchesVersions) {
            DefaultArtifactVersion cpeVersionStartExcluding = new DefaultArtifactVersion(versionStartExcluding);
            DefaultArtifactVersion cpeVersionEndExcluding = new DefaultArtifactVersion(versionEndExcluding);
            if (googleVersion.compareTo(cpeVersionStartExcluding) > 0) {
                if (googleVersion.compareTo(cpeVersionEndExcluding) < 0) {
                    matchesVersions = true;
                }
            }
        } // StartIncluding
        else if (!(versionStartIncluding == null) && !matchesVersions) {
            DefaultArtifactVersion cpeVersionStartIncluding = new DefaultArtifactVersion(versionStartIncluding);
            if (googleVersion.compareTo(cpeVersionStartIncluding) == 0
                    || googleVersion.compareTo(cpeVersionStartIncluding) > 0) {
                matchesVersions = true;
            }
        } // StartExcluding
        else if (!(versionStartExcluding == null) && !matchesVersions) {
            DefaultArtifactVersion cpeVersionStartExcluding = new DefaultArtifactVersion(versionStartExcluding);
            if (googleVersion.compareTo(cpeVersionStartExcluding) > 0) {
                matchesVersions = true;
            }
        } // EndIncluding
        else if (!(versionEndIncluding == null) && !matchesVersions) {
            DefaultArtifactVersion cpeVersionEndIncluding = new DefaultArtifactVersion(versionEndIncluding);
            if (googleVersion.compareTo(cpeVersionEndIncluding) == 0
                    || googleVersion.compareTo(cpeVersionEndIncluding) < 0) {
                matchesVersions = true;
            }
        } // EndExcluding
        else if (!(versionEndExcluding == null) && !matchesVersions) {
            DefaultArtifactVersion cpeVersionEndExcluding = new DefaultArtifactVersion(versionEndExcluding);
            if (googleVersion.compareTo(cpeVersionEndExcluding) < 0) {
                matchesVersions = true;
            }
        }
        return matchesVersions;
    }
}
